
import useBaseUrl from '@docusaurus/useBaseUrl';

## 概述

* 分区表允许把逻辑上的一个表在物理上分为很多部分。换句话说，分区表从物理上看是将一个大表分成几个小表，但是从逻辑上看，还是一个大表。

* 建议考虑分区表的情况：
  * 当数据库中某个表的数据量很大，在查询数据时会明显感觉到速度很慢
  * 数据是分段的，如以年份为分隔的数据，对于当前的数据经常进行增删改查操作，而对于往年的数据几乎不做操作或只做查询操作
  * 对数据的操作如果只涉及一部分数据而非全部数据

* 不建议考虑分区表的情况：
  * 如果一张表的数据经常进行增删改查操作，而不管年份之类的因素，这种情况最好不要考虑分区表

## SQL Server数据库

### 创建步骤

* 创建分表区的步骤分为5步：

  * 创建数据库文件组

  * 创建数据库文件

  * 创建分区函数

  * 创建分区方案

  * 创建分区表

### 查询表的大小

```
select schema_name(t.schema_id) as [Schema], t.name as TableName,i.rows as [RowCount]
from sys.tables as t, sysindexes as i
where t.object_id = i.id and i.indid <=1 order by rows DESC
```

<img alt=" " src={useBaseUrl('docimg/分区表4201.png')} />

* 这里可以看出H_Ext_KPI最大，下面就以此为例进行分区。

### 创建数据库文件组

***文件组用于将数据文件集合起来，以便于管理、数据分配和放置。***

* 为H_Ext_KPI建16个文件组

```
alter database <数据库名> add filegroup <文件组名>

---------------------------------------------

alter database imgenius add filegroup ExtKPI1
alter database imgenius add filegroup ExtKPI2
alter database imgenius add filegroup ExtKPI3
alter database imgenius add filegroup ExtKPI4
alter database imgenius add filegroup ExtKPI5
alter database imgenius add filegroup ExtKPI6
alter database imgenius add filegroup ExtKPI7
alter database imgenius add filegroup ExtKPI8
alter database imgenius add filegroup ExtKPI9
alter database imgenius add filegroup ExtKPI10
alter database imgenius add filegroup ExtKPI11
alter database imgenius add filegroup ExtKPI12
alter database imgenius add filegroup ExtKPI13
alter database imgenius add filegroup ExtKPI14
alter database imgenius add filegroup ExtKPI15
alter database imgenius add filegroup ExtKPI16
```

### 创建数据库文件

***一般情况下，我们建立数据库表时，表数据都存放在一个文件里。但是如果是分区表的话，表数据就会按照你指定的规则分放到不同的文件里，把一个大的数据文件拆分为多个小文件。这样文件的大小随着拆分而减小，还得到硬件系统的加强，自然对我们操作数据是大大有利的。***

```
alter database imgenius add file 
(name=N'KPI1',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI1.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI1
alter database imgenius add file 
(name=N'KPI2',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI2.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI2
alter database imgenius add file 
(name=N'KPI3',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI3.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI3
alter database imgenius add file 
(name=N'KPI4',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI4.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI4
alter database imgenius add file 
(name=N'KPI5',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI5.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI5
alter database imgenius add file 
(name=N'KPI6',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI6.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI6
alter database imgenius add file 
(name=N'KPI7',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI7.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI7
alter database imgenius add file 
(name=N'KPI8',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI8.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI8
alter database imgenius add file 
(name=N'KPI9',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI9.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI9
alter database imgenius add file 
(name=N'KPI10',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI10.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI10
alter database imgenius add file 
(name=N'KPI11',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI11.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI11
alter database imgenius add file 
(name=N'KPI12',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI12.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI12
alter database imgenius add file 
(name=N'KPI13',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI13.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI13
alter database imgenius add file 
(name=N'KPI14',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI14.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI14
alter database imgenius add file 
(name=N'KPI15',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI15.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI15
alter database imgenius add file 
(name=N'KPI16',filename=N'D:\WorkSoftWare\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KPI16.ndf',size=5Mb,filegrowth=5mb)
to filegroup ExtKPI16
```

### 创建分区函数

***根据指定列的值将表或索引的行映射到分区。分区列的数据类型除了大数据类型外，其他数据类型均可以。大数据类型有： text、ntext、image、xml、timestamp、varchar(max)、nvarchar(max)、varbinary(max)、alias数据类型或CLR用户定义的数据类型。常用的分区函数使用的数据类型是：日期类型和整数类型。***

* LEFT | RIGHT：决定边界值归属哪个方向区间。左边界右边界：就是把临界值划分给上一个分区还是下一个分区。一个小于号，一个小于等于号。

* 注意：例子中的边界值要根据实际数据库中的值来进行修改，不可以直接复制语句执行。如其中的第一个值'20140401'，需要修改为数据库正式使用的时间。

```
CREATE PARTITION FUNCTION 分区函数的名称(须唯一)(分区的列的数据类型 )  

AS RANGE [ LEFT | RIGHT ]   

FOR VALUES ( [边界值 [ ,...n ] ] )  
```

```
USE [imgenius]
GO
BEGIN TRANSACTION
CREATE PARTITION FUNCTION [kpi](int) AS RANGE LEFT FOR VALUES (N'20140401', N'20140701', N'20141001', N'20150101', N'20150401', N'20150701', N'20151001', N'20160101', N'20160401', N'20160701', N'20161001', N'20170101', N'20170401', N'20170701', N'20171001', N'20180101')
```

### 创建分区方案

***作用：将分区函数的分区映射到一个文件组或多个文件组的数据库对象。***

```
CREATE PARTITION SCHEME 分区方案名称 

AS PARTITION 使用分区方案的分区函数的名称 

[ALL] 全部分区指向一个文件组，只能指定一个文件组

TO

 ({file_group_name(文件组名称) | [PRIMARY]}[，…]N]) [;］

PRIMARY 是默认的文件组

分区被分配给文件组，分区和文件组一一对应

同一个文件组可以在[,...n]中指定多次。

如果n不足以容纳 分区函数数量，则创建分区方案失败并报错

如果分区函数生成的分区少于文件组数，则多出来的文件组再下一次添加分区的时候,会被使用
```

```
CREATE PARTITION SCHEME [kpi] AS PARTITION [kpi] TO ([ExtKPI1], [ExtKPI2], [ExtKPI3], [ExtKPI4], [ExtKPI5], [ExtKPI6], [ExtKPI7], [ExtKPI8], [ExtKPI9], [ExtKPI10], [ExtKPI11], [ExtKPI12], [ExtKPI13], [ExtKPI14], [ExtKPI15], [ExtKPI16], [ExtKPI16])
```

### 创建分区表

```
ALTER TABLE [dbo].[H_Ext_KPI] DROP CONSTRAINT [PK_H_Ext_KPI]


ALTER TABLE [dbo].[H_Ext_KPI] ADD  CONSTRAINT [PK_H_Ext_KPI] PRIMARY KEY NONCLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 85) ON [PRIMARY]


CREATE CLUSTERED INDEX [ClusteredIndex_on_kpi_636451424306135769] ON [dbo].[H_Ext_KPI]
(
	[ExecuteTimeDay]
)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF) ON [kpi]([ExecuteTimeDay])


DROP INDEX [ClusteredIndex_on_kpi_636451424306135769] ON [dbo].[H_Ext_KPI]


COMMIT TRANSACTION

```

### 查看结果

* 查看分区函数与分区方案

  <img alt=" " src={useBaseUrl('docimg/分区表4202.png')} />

* 查看分区文件

  <img alt=" " src={useBaseUrl('docimg/分区表4203.png')} />

* 查询分区表

```
SELECT CONVERT(VARCHAR(50),A.NAME) Partition_Scheme, D.Partition_Number, CONVERT(VARCHAR(10),E.NAME) FileGroup,
       CONVERT(VARCHAR(19),ISNULL(G.VALUE,''),120) Range_Boundary,STR(D.ROWS,9) Rows
FROM SYS.PARTITION_SCHEMES A INNER JOIN SYS.DESTINATION_DATA_SPACES B ON A.DATA_SPACE_ID = B.PARTITION_SCHEME_ID
    INNER JOIN SYS.INDEXES C ON A.DATA_SPACE_ID = C.DATA_SPACE_ID
    INNER JOIN SYS.PARTITIONS D ON B.DESTINATION_ID = D.PARTITION_NUMBER AND C.OBJECT_ID=D.OBJECT_ID AND C.INDEX_ID=D.INDEX_ID
    INNER JOIN SYS.DATA_SPACES E ON B.DATA_SPACE_ID = E.DATA_SPACE_ID
    INNER JOIN SYS.PARTITION_FUNCTIONS F ON A.FUNCTION_ID = F.FUNCTION_ID
    LEFT JOIN SYS.PARTITION_RANGE_VALUES G ON F.FUNCTION_ID = G.FUNCTION_ID AND D.PARTITION_NUMBER-F.BOUNDARY_VALUE_ON_RIGHT = G.BOUNDARY_ID
WHERE C.OBJECT_ID = OBJECT_ID('H_Ext_KPI')    --分区表名
    AND C.INDEX_ID IN (0,1)
ORDER BY Partition_Scheme,D.Partition_Number
```

<img alt=" " src={useBaseUrl('docimg/分区表4204.png')} />

* 查看文件及文件组

```
SELECT A.[NAME],A.PHYSICAL_NAME,A.[SIZE],A.GROWTH,B.[NAME] [FILEGROUP],B.IS_DEFAULT
FROM SYS.DATABASE_FILES A 
INNER JOIN SYS.FILEGROUPS B ON A.DATA_SPACE_ID = B.DATA_SPACE_ID
```

<img alt=" " src={useBaseUrl('docimg/分区表4205.png')} />

* 对于文件和文件组的备份请参考：[备份文件和文件组](https://learn.microsoft.com/zh-cn/SQL/relational-databases/backup-restore/back-up-files-and-filegroups-sql-server?view=sql-server-2017)

* 对于文件和文件组的还原请参考：[还原文件和文件组](https://learn.microsoft.com/zh-cn/sql/relational-databases/backup-restore/restore-files-and-filegroups-sql-server?view=sql-server-2017)

## PGSQL数据库