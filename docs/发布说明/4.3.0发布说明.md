
import useBaseUrl from '@docusaurus/useBaseUrl';

发布时间：待发布

## 增加的功能

1. [implus-22：Web端库存表支持通过选择作业组来实现库操作](#implus-22web端库存表支持通过选择作业组来实现库操作)
1. [implus-24：增加系统角色和粒度更细的权限控制](#implus-24增加系统角色和粒度更细的权限控制)
1. [implus-25：统一的Web配置和管理中心](#implus-25统一的web配置和管理中心)
1. [implus-63：改进部署工具](#implus-63改进部署工具)
1. [implus-64：终端支持手册蓝牙秤](#implus-64终端支持手册蓝牙秤)
1. [implus-68：作业组属性显示样式支持可视化配置](#implus-68作业组属性显示样式支持可视化配置)
1. [implus-112：在Windows平台支持同步AD用户](#implus-112在windows平台支持同步ad用户)
1. [implus-114：imFigure页面权限控制](#implus-114imfigure页面权限控制)
1. [implus-115：支持同步用户登录和修改控制](#implus-115支持同步用户登录和修改控制)
1. [implus-124：内置作业组属性报表](#implus-124内置作业组属性报表)
1. [implus-133：终端执行作业项逻辑创建作业，选择资产创建作业，直接点击返回时，不能标记为完成](#implus-133终端执行作业项逻辑创建作业选择资产创建作业直接点击返回时不能标记为完成)
1. [implus-158：EOC的资产详细页面中资产属性为json类型时，点击详细能够查看json属性值](#implus-158eoc的资产详细页面中资产属性为json类型时点击详细能够查看json属性值)
1. [implus-188：把关系引擎配置移植到Web配置里](#implus-188把关系引擎配置移植到web配置里)
1. [implus-192：接口跨平台](#implus-192接口跨平台)
1. [implus-214：SDC细节优化](#implus-214sdc细节优化)
1. [implus-222：SDC配置作业组属性每个分组的列头不随滚动条滚动](implus-222sdc配置作业组属性每个分组的列头不随滚动条滚动)
1. [implus-224：为流程活动“插入函数”增加例子](#implus-224为流程活动插入函数增加例子)
1. [implus-225：SMC细节优化](#implus-225smc细节优化)
1. [implus-231：EOC功能优化](#implus-231eoc功能优化)
1. [implus-235：EOC支持导入自定义数据并维护，终端支持可以使用和维护](#implus-235eoc支持导入自定义数据并维护终端支持可以使用和维护)
1. [implus-250：附件升级为文件库](#implus-250附件升级为文件库)
1. [implus-297：项目甘特图时间宽度修改和增加读取Excel内容的流程后函数类实例](#implus-297项目甘特图时间宽度修改和增加读取excel内容的流程后函数类实例)
1. [implus-361：自定义接口](#implus-361自定义接口)
1. [implus-381：终端功能优化](#implus-381终端功能优化)
1. [implus-427：作业项支持文件类型](#implus-427作业项支持文件类型)
1. [implus-475：JSON数据类型中支持文件类型](#implus-475json数据类型中支持文件类型)
1. [implus-496：消息通知功能增强](#implus-496消息通知功能增强)
1. [implus-509：终端显示资产属性页面增加显示某个属性的历史和趋势](#implus-509终端显示资产属性页面增加显示某个属性的历史和趋势)
1. [implus-511：终端默认数据库类型为sqllite数据库，样式为新样式](#implus-511终端默认数据库类型为sqllite数据库样式为新样式)
1. [implus-521：升级部署方式和安装盘](#implus-521升级部署方式和安装盘)

## 修复的问题

1. implus-20：隐藏的作业项在逻辑值切换后不隐藏，页面不会刷新
1. implus-65：EOC被第三方嵌入，查看JSON字符串的弹窗无法打开
1. implus-79：终端数值，字符串（多行），时间类型作业项输入值没有保存草稿
1. implus-80：自定义KPI，维度-作业组属性-时间为来源时，有错误
1. implus-93：imFigure中，从可导入、下载静态数据的组件切换为无数据源的组件，再切换回来后，也会变成不可导入、下载
1. implus-132：发布计划后修改作业组模板所属组织单元（修改完不发布），计划页面中不可查看的计划就会显示出来
1. implus-134：资产报警配置创建作业，创建出来的作业组名称在计划页面和作业树页面不一致
1. implus-141：通过脚本设置JSON类型作业组属性的值，无法就地显示
1. implus-146：imFigure的项目大屏在安卓盒子中无法显示
1. implus-147：网站设置中已有登录logo或主页顶部logo，保存后再设置网站配置会报错
1. implus-177：EOC中有配置Excel模板的作业项历史报表和资产属性报表、资产历史属性报表等报表，切换表格或Excel模板按钮时，页面无变化
1. implus-182：作业项（历史）报表下载Excel，签名不显示
1. implus-190：EOC查看JSON属性的弹框中，如果有多选列表属性点击表格视图会报错
1. implus-191：组织单元查看权限的配置在库存条目表中没有作用
1. implus-200：作业树页面搜索和高亮功能无效果
1. implus-243：流程中有分支的作业组，在报表中点进作业树界面后，点击返回，报表数据不显示，需刷新才可以
1. implus-246：EOC上我的作业组中，活动实例状态列作为查询条件无法生效
1. implus-247：终端为sqllite数据库，当作业项名称中含有英文问号，导致终端同步出错
1. implus-298：终端库操作，不存在的物料，还能显示数量
1. implus-325：作业组属性中有必填项未填写时，点击完成，提示查看，不会跳转定位到该必填项处
1. implus-345：终端审核页面-作业树中国，摘要信息过滤选择框显示不正确
1. implus-349：作业组属性报表bug
1. implus-350：EOC网站设置中，如果做了选择文件的配置，之后再做其他配置就无法生效
1. implus-351：SDC导入工程时，数据比较大会出现导入不进去
1. implus-352：子项模板下有执行项，在项目详细中引用该子项模板然后删除，该子项模板下的执行项并没有在计划页面一并删除掉。只增加执行项然后删除也是一样
1. implus-354：终端调用接口不要影响离线工作
1. implus-355：EOC的项目甘特图里的时间如果为9999-xx-xx，应视为空
1. implus-356：SDC流程中，条件的线如果是从别的活动改道过来，不会有true/false判断，且验证不会报错，流程也会走不通
1. implus-358：终端主页表格样式视图显示会有阴影遮挡
1. implus-378：项目中的执行项在执行后，其计划开始和结束时间返回不正确
1. implus-403：SDC作业组属性如果存在列表类型的属性，选择其他类型的属性-插入属性时，也会带上列表类型
1. implus-407：脚本修改作业组属性，可查看和不可见处理规则不一致
1. implus-408：EOC审核如果作业组属性值中含有英文单引号会保存失败
1. implus-409：终端新样式在同一作业组多执行时显示不正确
1. implus-410：EOC个性设置的配置表格模板中配置$tp.xxx不起作用
1. implus-418：表单模式下文件类型在终端下载错误
1. implus-428：EOC作业树多次调用后台获取树
1. implus-434：pg数据库，批量处理中最大时间会导致查询出问题
1. implus-473：作业组属性报表合并显示出错，样式设置完成之后不能保存
1. implus-498：终端审核中作业组属性一组状态全部为不可见，会显示出组名

## 增加的功能详细说明

### implus-22：Web端库存表支持通过选择作业组来实现库操作

* 在EOC库存表的库操作中，除原有的直接操作外，新增加了以作业组操作。与计划页面一样，勾选即时创建则直接创建，不勾选则为计划。同时也可以修改作业组名称和描述。

  <img alt=" " src={useBaseUrl('docimg/库存表4301.png')} />

* 在SDC作业组模板基本属性中，新增了一个按钮名为“库存工单”，勾选了此项的作业组模板才会出现在库存表以作业组操作的作业组模板列表中。该作业组模板也需要有库存操作的作业组属性。

  <img alt=" " src={useBaseUrl('docimg/库存表4302.png')} />

* 之后，在库存表界面以作业组操作就可以通过编辑库存操作的作业组属性，来完成库操作了，相当于在库存表页面可以直接计划或创建一个库存操作的作业组。

### implus-24：增加系统角色和粒度更细的权限控制

* 在Web配置和管理中心-系统中，新增了系统角色的配置，在web配置中进行配置后，可以在Web配置和管理中心的用户基本属性或SDC的用户基本属性中，为用户选择配置好的系统角色，以此来控制用户在Web配置和管理中心里的权限。（注意：目前EOC和终端，不受此权限控制，后续会进行整合。）

  <img alt=" " src={useBaseUrl('docimg/系统角色4301.png')} />

* 如图，新建并配置了一个名为只有岗位的系统角色。

  <img alt=" " src={useBaseUrl('docimg/系统角色4302.png')} />

* 之后在Web配置的组织架构-用户，选择一个用户点击编辑，或者SDC组织架构管理器的用户中选择一个用户，为其选择上系统角色。

  <img alt=" " src={useBaseUrl('docimg/系统角色4303.png')} />

  <img alt=" " src={useBaseUrl('docimg/系统角色4304.png')} />

* 最后用该用户登录EOC，进入Web配置和管理中心，可以看到该用户只能对岗位菜单进行查看和编辑等操作了。

  <img alt=" " src={useBaseUrl('docimg/系统角色4305.png')} />

### implus-25：统一的Web配置和管理中心

* Web配置和管理中心进一步升级优化，将更多的SDC配置功能Web化。

* 左侧菜单新增加了作业管理，系统-系统角色，和高级。作业管理中包括作业组模板、作业规范和项目模板。系统-系统角色中，可以进行粒度更细的权限控制。高级中，将关联关系引擎移植了过来，无需进行额外的配置。

* 功能上增加了拷贝ID、Excel的导入导出、整个工程的导入导出、对于各实体基本属性和扩展属性的编辑等等。另外作业管理-作业组模板中增加了Web端才可以进行配置的自定义表单功能，用来对作业组属性的显示样式进行自定义配置。

  <img alt=" " src={useBaseUrl('docimg/web配置4301.png')} />

### implus-63：改进部署工具

* 可以选择不删除以前的网站。部署工具中新增加了部署前删除旧网址选项，如果勾选就会删除旧网站再部署，不勾选则保留旧网站。这样如果以前的网站配置了端口或证书，不删除后也就不需要重新配置。

  <img alt=" " src={useBaseUrl('docimg/部署工具4301.png')} />

* 原来的网站物理路径如果有很多文件，部署会较慢，优化了部署速度。

* 优化了部署路径的识别，点击使用默认设置会根据安装目录生成正确的各部署包路径。

### implus-64：终端支持手册蓝牙秤

* 终端在支持蓝牙电子秤功能升级，支持新设备的数据格式。

  <img alt=" " src={useBaseUrl('docimg/蓝牙秤4301.png')} />

* 升级后的区别

  <img alt=" " src={useBaseUrl('docimg/蓝牙秤4302.png')} />

### implus-68：作业组属性显示样式支持可视化配置

* 在Web配置和管理中心-作业管理-作业组模板中，新增了自定义表单功能，此功能并不是表单模式的增强，而是可以自定义作业组属性在EOC和终端上的显示样式，并且可以较为简单的去配置出在SDC里无法配置或配置起来比较复杂的需求。

:::tip 注意
自定义表单的配置适用于只有作业组属性的作业组模板，如果有作业和作业项，不会显示也不能执行。如果想要在作业树中显示的样式也为自定义表单的样式，则需要勾选表单模式。
:::tip 注意

* 首先，SDC里已经建好了作业组属性后，在EOC上点进Web配置和管理中心-作业管理-作业组模板，可以看到自定义表单选项，点击进入自定义表单配置页面。

  <img alt=" " src={useBaseUrl('docimg/自定义表单4301.png')} />

  <img alt=" " src={useBaseUrl('docimg/自定义表单4302.png')} />

* 进入自定义表单页面，可以看到属性显示与SDC里的作业组属性一致，之后就可以开始配置其显示样式了。

* 页面左侧为各种组件，自行拖动各种组件来对应作业组属性也是可以的。右侧为配置栏，可以设置必填、隐藏、禁用等，可以写各类脚本，写法与SDC中基本相同，同时也可以配置显示的格式样式。其中属性名栏，如果是自行拖动组件来进行配置的话，其值必须填写与SDC中作业组属性名一样。

* 如图，配置的样式为，将“未完成原因”配置为必填，且当“是否完成”的值为“否”时，“未完成原因”和“人员”这两个属性才会显示出来，并且必填才会生效。

  <img alt=" " src={useBaseUrl('docimg/自定义表单4303.png')} />

* 想要实现这个效果，只需要在“未完成原因”和“人员”中写一个简单的隐藏脚本即可，脚本窗口右侧内置有脚本的写法。

  <img alt=" " src={useBaseUrl('docimg/自定义表单4304.png')} />

* 配置完保存之后，在SDC的作业组基本属性框-自定义报表处，会自动生成一个表单的值，有这个值，那么该作业组就会显示自定义表单样式，删除掉这个值，就显示为原样式。

  <img alt=" " src={useBaseUrl('docimg/自定义表单4306.png')} />

* 自定义表单中进行了配置后，如果点击清空重置，则回复到初始样式，所有在此界面进行的配置都清空。如果在SDC中进行了属性的修改，同时不希望自定义表单中已做好的配置失效，点击合并重置即可。

* 实际效果：

  <img alt=" " src={useBaseUrl('docimg/自定义表单4305.gif')} />

* 数据格式为Json的属性，默认有两种显示样式，可以自由切换，一种为常规列表样式，一种为表格列表样式。

  <img alt=" " src={useBaseUrl('docimg/自定义表单4307.gif')} />

:::tip 注意
自定义表单中的配置在保存后，要在SDC中重新打开解决方案，重新发布该作业组模板，才会生效。
:::tip 注意

### implus-112：在Windows平台支持同步AD用户

### implus-114：imFigure页面权限控制

* imFigure页面权限控制增强，页面的登录权限与当前登录人员的EOC端权限一致，页面中的新建、编辑、查看和删除等权限，由Web配置和管理中心-系统中的系统角色资源权限来决定，包括大屏盒子和项目大屏。

  <img alt=" " src={useBaseUrl('docimg/imFigure4301.png')} />
  <img alt=" " src={useBaseUrl('docimg/imFigure4302.png')} />

### implus-115：支持同步用户登录和修改控制

### implus-124：内置作业组属性报表

* 将作业组属性报表内置到了报表当中，省去了自定义配置的步骤，直接在作业组属性报表中勾选作业组和作业组属性就可以直接展示出来。原本的在系统扩展管理中添加自定义xml文件的方式也依然支持。

  <img alt=" " src={useBaseUrl('docimg/作业组属性报表4301.png')} />

### implus-133：终端执行作业项逻辑创建作业，选择资产创建作业，直接点击返回时，不能标记为完成

* 终端作业项创建作业功能优化，现在触发创建作业逻辑，若不选择资产，直接返回的作业组，不能标记为完成。返回则直接退出执行页面，再次进入时，会重新要求选择资产，选择了才可以继续执行。

  <img alt=" " src={useBaseUrl('docimg/终端创建作业4301.gif')} />

### implus-158：EOC的资产详细页面中资产属性为json类型时，点击详细能够查看json属性值

* 在EOC端，资产总览中，当资产属性为json类型时，点击详细，可以查看到json属性值。

  <img alt=" " src={useBaseUrl('docimg/资产总览4301.png')} />

### implus-188：把关系引擎配置移植到Web配置里

* 将关系引擎的配置，直接移植到了Web配置中，部署包中不再包含关系引擎包（RelationEngine），部署工具里也去掉了包含关系引擎的选项。只要部署了Web配置，然后在系统扩展管理-自定义报表-内置扩展中添加配置与管理中心，之后在Web配置和管理中心页面的高级中，就可以看到关系引擎编辑器。

  <img alt=" " src={useBaseUrl('docimg/关系引擎4301.png')} />

  <img alt=" " src={useBaseUrl('docimg/关系引擎4302.png')} />

  <img alt=" " src={useBaseUrl('docimg/关系引擎4303.png')} />

### implus-192：接口跨平台

* 从4.3.0开始，使用新的RESTful API接口，接口帮助的网站访问地址由原来的`http://localhost:8010`变为`http://localhost:8010/swagger/index.html`，仍然是通过部署工具部署imMsg压缩包到指定位置，另外SMC设置中填写的消息系统内外网的访问网址也不变还是`http://localhost:8010`和`http://ip地址:8010`。

  <img alt=" " src={useBaseUrl('docimg/接口4301.png')} />

### implus-214：SDC细节优化

* 作业规范发布与未发布的颜色不好区分，改为更明显的颜色。现在与作业组中发布和未发布的颜色保持一致。

  <img alt=" " src={useBaseUrl('docimg/SDC4301.png')} />

* 允许作业组流程中不配置计划和创建活动，以方便按需创建的作业组的配置和验证。

  <img alt=" " src={useBaseUrl('docimg/SDC4306.png')} />

* json的数据格式配置不显示。如果是库操作类型，显示已配置为库操作；如果是json数组类型，显示已配置为Json数组；如果是json类型，显示为已配置为Json对象。

  <img alt=" " src={useBaseUrl('docimg/SDC4302.png')} />

* 默认的作业组分组、作业规范分组、附件中的语音提示，内置到所有解决方案模板中。

  <img alt=" " src={useBaseUrl('docimg/SDC4303.png')} />
  <img alt=" " src={useBaseUrl('docimg/SDC4304.png')} />

* 去掉资产号旁的读取和写入按钮。

  <img alt=" " src={useBaseUrl('docimg/SDC4305.png')} />

* 作业项逻辑创建作业规范和按需创建时增加提示。当配置作业项创建作业逻辑时，如果选择的作业规范没有勾选终端按需创建，会在选择后弹出在终端无法创建的提示。

  <img alt=" " src={useBaseUrl('docimg/SDC4307.png')} />

### implus-222：SDC配置作业组属性每个分组的列头不随滚动条滚动

* 在SDC中配置作业组属性时，每个分组的列头可以不随滚动条滚动，锁定起来方便流程活动实例权限的配置，类似于excel的首行冻结。

  <img alt=" " src={useBaseUrl('docimg/SDC4308.png')} />

### implus-224：为流程活动“插入函数”增加例子

* 在SDC流程活动的属性-活动结束事件-插入函数中，选择了某个流程后函数之后，在该函数的简单说明框中，除原有的函数原型、类和描述外，为每个流程后函数的说明增加了例子，方便更好的理解流程后函数的作用及使用。

  <img alt=" " src={useBaseUrl('docimg/业务流程4301.png')} />

### implus-225：SMC细节优化

* 同步端口8090加入到配置里，在SMC系统设置-服务中，增加了同步服务监听端口的配置，可以自行设置同步的端口，不用再去同步文件中修改。

  <img alt=" " src={useBaseUrl('docimg/SMC优化4301.png')} />

* 增加RabbitMQ测试，将RabbitMQ的连接信息从系统设置中去掉，与Mongo一样放到右侧属性栏中，并增加测试连接。

  <img alt=" " src={useBaseUrl('docimg/SMC优化4302.png')} />

* 增加系统环境诊断，在SMC左上方菜单栏中，增加了系统环境诊断，可以诊断当前系统运行的服务器信息、应用版本、授权信息、数据库的运行连接情况、MongoDB和RabbitMQ服务的运行连接情况、EOC和API的连接验证、Websocket服务器的连接，以及imgenius七大服务的运行状态。

### implus-231：EOC功能优化

* 主页增加待我处理的工作Widget（代办中心），同时增加今日计划和今日作业组Widget。

  <img alt=" " src={useBaseUrl('docimg/主页4301.png')} />

* 管理导航时，人员可选择超级管理员。

  <img alt=" " src={useBaseUrl('docimg/导航4301.png')} />

* 计划显示时，如果某个计划已归档，则计划头部颜色固定为深绿色。

  <img alt=" " src={useBaseUrl('docimg/计划4301.png')} />

* 计划选择作业组模板时，如果右边有筛选，则只能选择这些已选中的作业组模板。

  <img alt=" " src={useBaseUrl('docimg/计划4302.png')} />

* 逻辑行为为空的例外等级，在作业树中可以修改。在作业项逻辑中，逻辑行为为空并关联了例外等级，这种配置在作业树上，无法去修改例外等级的值。而有行为的是可以修改的。优化后，行为是空的也可以去修改。

  <img alt=" " src={useBaseUrl('docimg/eoc优化4301.png')} />

* 活动中、归档、我的、作业组报表筛选器优化。活动中作业组、归档作业组、我的作业组和作业组报表，开始时间名称改为改为执行开始时间，不选择，增加了创建时间，默认选择本周。

  <img alt=" " src={useBaseUrl('docimg/eoc优化4302.png')} />

* EOC下载终端二维码自动生成。EOC端下载终端应用中，二维码改为自动生成。基础版应用位于EOC部署路径下APK文件夹中，如C:\inetpub\wwwroot\APK；人脸识别版应用位于EOC部署路径下imMW文件夹中，如C:\inetpub\wwwroot\imMW；imFigure应用位于EOC部署路径下imFigure文件夹中，如C:\inetpub\wwwroot\imFigure。

  <img alt=" " src={useBaseUrl('docimg/eoc优化4303.png')} />

* 作业树特殊视图（Word、Excel）优化。

### implus-235：EOC支持导入自定义数据并维护，终端支持可以使用和维护

* 在EOC端Web配置与管理中心，增加自定义实体功能。当遇到大量的自定义数据时，可以使用和维护。简化了[同步和使用自定义数据](/系统扩展指南/同步和使用自定义数据.md)的配置和操作，不需要再在数据库中做任何操作。

* 首先进入Web配置中，高级-自定义实体类型，新建完一个类型后，数据库中就会自动创建出数据表。

  <img alt=" " src={useBaseUrl('docimg/自定义实体4301.png')} />

* 然后，为这个实体类型新建属性，新建完属性后会在数据表中自动增加相应的字段，支持所有数据类型。新建SyncResource文件夹和其中的ExternalEntity.json文件这一步骤也不再需要，会在imgenius/Services文件夹中自动创建出来。

  <img alt=" " src={useBaseUrl('docimg/自定义实体4302.png')} />

:::tip 注意
在终端上要使用哪个属性，就需要将该属性的终端同步勾选上，至少要勾选一个。
:::tip 注意

* 之后，进入自定义实体页面，选择自定义实体类型，不选择则默认为自定义实体类型里的第一个。新建自定义实体，或通过已经填好数据的excel直接导入。excel中必须有一列为名称，并且值不要重复，重复的只导入一次。

  <img alt=" " src={useBaseUrl('docimg/自定义实体4303.png')} />

* excel中的列名与实体类型中的属性名一致的，相应的数据会自动填入实体的属性中作为属性值，并更新到数据库表里，如果excel中有Description/描述列，不需要在实体类型中新建该属性，在实体页面进行导入时，数据会自动填入对应实体的描述中。

  <img alt=" " src={useBaseUrl('docimg/自定义实体4304.png')} />

  <img alt=" " src={useBaseUrl('docimg/自定义实体4305.png')} />

  <img alt=" " src={useBaseUrl('docimg/自定义实体4306.png')} />

* 在终端上使用此自定义实体数据，在作业项、作业组属性更多设置、json中属性的更多设置里，点击可选项脚本，如下脚本作用为获取故障代码表中的Itemnumber返回一个列表。

```js
// 终端-作业项可选项脚本
var resultName = ScriptEngine.GetResultName();
ScriptEngine.GetCustomEntityData('故障代码', 'ID,Itemnumber', '', function (_list) {
    var list = [];
    if (_list && _list.length > 0) {
        for (var i = 0; i < _list.length; i++) {
            var row = _list[i];
            var obj = { 'ID': row['ID'], 'Name': row['Itemnumber'] }
            list.push(obj);
        }
    }
    ScriptEngine[resultName] = list;
});

return { 'ResultName': resultName };
```

```js
// EOC-作业组属性可选项脚本
var resultName = ScriptEngine.GetResultName();
ScriptEngine.GetCustomEntityData('故障代码', 'ID,Itemnumber', '', function (_list) {
    var list = [];
    if (_list && _list.length > 0) {
        for (var i = 0; i < _list.length; i++) {
            var row = _list[i];
            var obj = { 'ID': row['ID']||row['id'], 'Name': row['Itemnumber']||row['itemnumber'] }
            list.push(obj);
        }
    }
    ScriptEngine[resultName] = list;
});

return { 'ResultName': resultName };
```

* 其中，`ScriptEngine.GetCustomEntityData('故障代码', 'ID,Itemnumber', '', function (_list)`，为调用函数获取数据，参数分别为实体类型名称、要获取的字段名（与实体属性中自定义的名称一致）、查询条件（比如写为`'故障代码', 'ID,Itemnumber', 'Itemnumber=LNE-O-S17'，则返回的就是值为LNE-O-S17的Itemnumber列表`）
* 而`var obj = { 'ID': row['ID'], 'Name': row['Itemnumber'] }`部分，是创建一个对象obj，该对象具有两个属性：ID和Name，属性值分别为row对象中键为ID和Itemnumber的值，在EOC上使用时，这一句增加了兼容小写的内容。

  <img alt=" " src={useBaseUrl('docimg/自定义实体4307.png')} />

* 可以在该作业项的逻辑脚本条件中，填加下面的脚本，上面说到终端上执行时，该作业项可选择的值就是故障代码中ItemNumber字段的值，而添加上此脚本，该作业项选完值后，会将ItemNumber值所对应的Description值自动填入"故障原因"作业项中，实现类似于自定义列表关联关系的功能。

```js
// 终端-作业(项)逻辑-脚本条件
var resultName = ScriptEngine.GetResultName();

// 获取作业项的值
var taskItemValue = @Me.Value ;

// 将作业项的值设置为作业组的"故障"属性值
ScriptEngine.Context.SetTaskGroupPropertyValue('故障', taskItemValue);

// 检查作业项的值是否存在
if (taskItemValue) {
    // 使用自定义方法获取故障代码的数据
    ScriptEngine.GetCustomEntityData('故障代码', 'ID,Itemnumber,BI_Description', '', function (_result) {
        // 根据作业项的值筛选故障代码数据
        var filter = _result.filter(function (_item) { return _item.Itemnumber == taskItemValue });

        // 查找名称为"故障原因"的作业项
        var reasonTask = ScriptEngine.Context.curTasks.find(function (_item) { return _item['Name'] == '故障原因' });

        // 检查是否找到了"故障原因"作业项
        if (reasonTask) {
            // 获取故障代码对应的描述(BI_Description)
            var value = filter.length > 0 ? filter[0]['BI_Description'] : '';

            // 设置"故障原因"作业项的值为故障代码描述
            ScriptEngine.Context.SetTaskAttributeValue(reasonTask.ID, 'Value', value);
        }

        // 清空结果以及作业项的值
        ScriptEngine[resultName] = '';
    });
} else {
    // 清空结果以及作业项的值
    ScriptEngine[resultName] = '';
}

// 返回一个包含结果名称的对象
return { 'ResultName': resultName };
```

### implus-250：附件升级为文件库

* 附件功能升级，在EOC端增加文件库功能，可以对附件进行类别专业系统形式的分级分类属性管理。

  <img alt=" " src={useBaseUrl('docimg/文件库4301.png')} />

* 在管理分类中，可以配置附件可选的分级和分类

  <img alt=" " src={useBaseUrl('docimg/文件库4302.png')} />

* 上传中可以选择附件上传，并为其配置分级分类属性，可选该附件上传后是否允许下载，是否加密该文件，当有同名附件时可选择覆盖或跳过。

  <img alt=" " src={useBaseUrl('docimg/文件库4303.png')} />

* 下载按钮可以下载当前页面附件目录的excel，同时也支持配置查询条件。

* 此外，每个附件都可以单独进行下载、删除、编辑属性和重命名。

### implus-297：项目甘特图时间宽度修改和增加读取Excel内容的流程后函数类实例

* 项目中时间宽度和排程优化，执行项会按照归档时间排程，自动排程会参考当前时间，如果小于当前时间时，起点会变为为当前时间+5分钟。

* 增加了读取Excel内容的流程后函数类实例，可以从作业组文件属性中读取Excel内容，设置给例如下图中出库的操作项

  <img alt=" " src={useBaseUrl('docimg/流程后脚本4301.png')} />

* 脚本内容如下：

```js
// 从作业组文件属性中读取Excel内容，设置给出库的操作项
var taskGroupID = curTaskGroup.ID;
// 获取作业组属性
var getProperty = function (_propertyName) {
    var property = null;
    var url = 'Report/GetTaskGroupPropertyByName?taskGroupID=' + taskGroupID + '&name=' + _propertyName;
    var result = imClient.Get(url);
    var resultObj = JSON.parse(result);
    if (resultObj) {
        if (resultObj.IsOk) {
            property = resultObj.Response;
            imLogWriter.WriteError('获取作业组属性 ' + _propertyName + ' 调用成功，返回数据为：' + JSON.stringify(property));
        }
        else {
            imLogWriter.WriteError('获取作业组属性 ' + _propertyName + ' 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
        }
    }
    else {
        imLogWriter.WriteError('获取作业组属性 ' + _propertyName + ' 调用失败，返回为：' + result);
    }
    return property;
};
// 获取作业组文件属性Excel文件内容
var getExcelContent = function (_propertyName) {
    var list = null;
    var content = excelTool.ReadByTaskGroupProperty(taskGroupID, _propertyName, false);
    if (content) {
        list = JSON.parse(content);
    }
    else {
        imLogWriter.WriteError('从作业组文件属性 ' + _propertyName + ' 读取到的Excel内容为空');
    }
    return list;
};
// 保存作业组属性值
var savePropertyValue = function (_propertyName, _value) {
    var success = false;
    var url = 'Report/ModifyTaskGroupPropertyValueByName?id=' + taskGroupID + '&propertyName=' + _propertyName + '&value=' + _value;
    var result = imClient.Put(url);
    var resultObj = JSON.parse(result);
    if (resultObj) {
        if (resultObj.IsOk) {
            imLogWriter.WriteError('修改作业组属性 ' + _propertyName + ' 调用成功，返回数据为：' + JSON.stringify(resultObj.Response));
            success = true;
        }
        else {
            imLogWriter.WriteError('修改作业组属性 ' + _propertyName + ' 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
        }
    }
    else {
        imLogWriter.WriteError('修改作业组属性 ' + _propertyName + ' 调用失败，返回为：' + result);
    }
    return success;
};
var list = getExcelContent('BOM清单文件');
if (list && list.length > 0) {
    var property = getProperty('领料');
    if (property) {
        var pvObj = null;
        if (property.Value) {
            pvObj = JSON.parse(property.Value);
        }
        if (!pvObj) {
            pvObj = { '来源存储区域': '', '操作项': [], '存放位置': '' };
        }
        var operaList = [];
        for (var i = 0; i < list.length; i++) {
            var item = {
                '物料': list[i]['编号'],
                '数量': list[i]['数量'],
                '单位': list[i]['单位']
            };
            operaList.push(item);
        }
        pvObj['操作项'] = operaList;
        savePropertyValue('领料', JSON.stringify(pvObj));
    }
}
```

### implus-361：自定义接口

* 在Web配置与管理中心里，增加了自定义接口功能，可以自己定义一个接口，在定义的接口中写好脚本（流程后脚本）。在系统需要此脚本时，可以直接调用这个接口来实现执行该脚本的功能。
* 如果在一个解决方案中有比较多的用途重复的脚本，使用此功能可以更快速简单的进行配置，并且对于脚本的管理也更清晰；而如果在解决方案中用到的流程后脚本都是不同的，可以选择性使用此功能。

  <img alt=" " src={useBaseUrl('docimg/自定义接口4301.png')} />

* 以创建作业组计划为例，如图写在自定义脚本的Post脚本中并启用，完整的脚本如下：

```js
var curTaskGroup = paramers;  // 获取参数中的当前作业组对象

// 根据作业组模板名称获取要创建的作业组模板
var taskGroupTemplate = null;
var taskGroupTemplateName = curTaskGroup.planTaskGroupName;
var url = 'TaskGroupTemplate/GetByName?name=' + taskGroupTemplateName;
var result = imClient.Get(url);  // 调用接口获取作业组模板
var resultObj = JSON.parse(result);  // 解析接口返回结果为对象
if (resultObj) {
    if (resultObj.IsOk) {
        taskGroupTemplate = resultObj.Response;  // 如果接口调用成功且返回结果正确，则将作业组模板赋值给taskGroupTemplate变量
    } else {
        imLogWriter.WriteError('根据作业组模板名称得到要创建的作业组模板 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
    }
} else {
    imLogWriter.WriteError('根据作业组模板名称得到要创建的作业组模板 调用失败，返回为：' + result);
}

if (!taskGroupTemplate) {
    imLogWriter.WriteError('“' + taskGroupTemplateName + '” 作业组模板不存在，无法创建计划');
} else {
    // 获取当前作业组所有属性，将需要同步的属性复制到新创建的作业组中
    var taskGroupPropertyList = null;
    var url = 'Report/GetTaskGroupProperties?taskGroupID=' + curTaskGroup.ID;
    var result = imClient.Get(url);  // 调用接口获取作业组属性列表
    var resultObj = JSON.parse(result);  // 解析接口返回结果为对象
    if (resultObj) {
        if (resultObj.IsOk) {
            taskGroupPropertyList = resultObj.Response;  // 如果接口调用成功且返回结果正确，则将作业组属性列表赋值给taskGroupPropertyList变量
        } else {
            imLogWriter.WriteError('获取当前作业组所有属性 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
        }
    } else {
        imLogWriter.WriteError('获取当前作业组所有属性 调用失败，返回为：' + result);
    }

    // 赋值新创建作业组的属性值
    var createOrderProperty = null;
    var newTaskGroupProperties = [];
    if (taskGroupPropertyList && taskGroupPropertyList.length > 0) {
        for (var index = 0; index < taskGroupPropertyList.length; index++) {
            var tp = taskGroupPropertyList[index];
            if (tp.Name == '创建的工单')
                createOrderProperty = tp;  // 找到名称为"创建的工单"的属性，并将其赋值给createOrderProperty变量
            else if (tp.Name == '界区')
                newTaskGroupProperties.push({ PropertyName: tp.Name, Value: tp.Value });  // 将名称为"界区"的属性添加到newTaskGroupProperties数组中
        }
    }
    // 设置"来源工单"属性
    var source = [{ ID: curTaskGroup.ID, Name: curTaskGroup.Name }];
    newTaskGroupProperties.push({ PropertyName: '来源工单', Value: JSON.stringify(source) });

    // 构造创建计划的参数
    var startTime = lib.System.DateTime.Now.AddHours(1).ToString('yyyy-MM-dd HH:mm:ss');
    var endtime = lib.System.DateTime.Now.AddHours(3).ToString('yyyy-MM-dd HH:mm:ss');
    var modifyName = taskGroupTemplate.Name + ' - 修改后的名称';
    var modifyDesc = taskGroupTemplate.Description + ' - 修改后的描述';
    var plan = {
        TaskGroupID: taskGroupTemplate.ID,
        PlanStatus: 2,
        Name: taskGroupTemplate.Name,
        IsModifyTaskGroupNameDescription: true,
        ModifyTaskGroupName: modifyName,
        ModifyTaskGroupDescription: modifyDesc,
        PlanTime: {
            StartTime: startTime,
            EndTime: endtime,
            RepeatedModeType: 1,
            RepeatedRange: {
                EndTimeType: 1
            }
        },
        SetTaskGroupProperties: JSON.stringify(newTaskGroupProperties)
    };

    // 调用接口创建计划
    var newTaskGroupID = '';
    var result = imClient.Post('Schedule/CreateTaskGroup', JSON.stringify(plan));  // 调用接口创建新的作业组计划
    var resultObj = JSON.parse(result);  // 解析接口返回结果为对象
    if (resultObj) {
        if (resultObj.IsOk) {
            newTaskGroupID = resultObj.Response.TaskGroupID;  // 如果接口调用成功且返回结果正确，则将新创建的作业组ID赋值给newTaskGroupID变量
        } else {
            imLogWriter.WriteError('创建计划 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
        }
    } else {
        imLogWriter.WriteError('创建计划 调用失败，返回为：' + result);
    }

    if (newTaskGroupID && createOrderProperty) {
        // 将新创建的作业组信息写入当前作业组的"创建的工单"属性中
        var oldValue = createOrderProperty.Value;
        if (oldValue)
            oldValue = JSON.parse(oldValue);
        else
            oldValue = [];
        oldValue.push({ ID: newTaskGroupID, Name: modifyName });

        var url = 'Report/ModifyTaskGroupPropertyValueByName?id=' + curTaskGroup.ID + '&propertyName=创建的工单&value=' + encodeURIComponent(JSON.stringify(oldValue));
        var result = imClient.Put(url);  // 调用接口修改作业组属性
        var resultObj = JSON.parse(result);  // 解析接口返回结果为对象
        if (resultObj) {
            if (resultObj.IsOk) {
                imLogWriter.WriteInfo('修改作业组属性成功');
            } else {
                imLogWriter.WriteError('修改作业组属性 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
            }
        } else {
            imLogWriter.WriteError('修改作业组属性 调用失败，返回为：' + result);
        }
    }
}

return '';
```

* SDC中流程后脚本的配置如下：

```js
var url = 'Custom/测试';  // 固定写法，请求的接口路径，这是一个名为测试的自定义接口
var body = {
    ID: curTaskGroup.ID,  // 当前作业组的ID
    Name: curTaskGroup.Name,  // 当前作业组的名称
    planTaskGroupName: '隐患整改'  // 需要创建的作业组名称
}
imClient.Post(url, JSON.stringify(body));  // 调用接口，向服务器发送POST请求，将body数据作为请求体传递给服务器

// 使用POST方法调用了名为’Custom/测试’的接口，将一个包含当前作业组ID、名称和计划作业组名称的JSON串作为请求体发送给服务器
```

* 自定义接口跟直接在作业组属性更多设置里写流程后脚本有所不同，没有当前作业组这个概念，所以需要通过传入的参数获取要创建的作业组模板，并进行判断是否存在。因此，需要通过`var curTaskGroup = paramers;`获取在SDC中定义好的参数，SDC脚本中的body，在自定义接口中为paramers，所以这一句是获取body的作用。body中可以看到，设置好了一些参数，这个是根据流程后脚本中需要的参数来设定的。简单来说，自定义接口中的脚本就是一个通用的脚本，SDC脚本中只需要改需要创建的作业组名称就可以了。

  <img alt=" " src={useBaseUrl('docimg/自定义接口4302.png')} />

### implus-381：终端功能优化

* 终端支持注册设备。终端在配置-通用界面中，增加了注册设备按钮，位于设备ID下方。点击后会在SMC中自动新建终端，并在终端描述中会有注册信息，只需要勾选启用即可。

  <img alt=" " src={useBaseUrl('docimg/终端优化4301.png')} />

  <img alt=" " src={useBaseUrl('docimg/终端优化4302.png')} />

* 终端对于已完成未同步的作业组增加明显标识和提示。终端上如果存在有已完成未同步的作业组，会在下方同步按钮旁显示此类作业组的数量。如图，数字为2表示执行里面的3个作业组，其中有两个是完成未同步的状态。

  <img alt=" " src={useBaseUrl('docimg/终端优化4303.png')} />

* 静默同步失败时，可以每隔一段时间自动再运行。由于终端上有时会出现作业组完成后同步不成功，或标记为完成但未同步的作业组，都会出现在已完成界面中的未同步里。这种往往没有提醒或日志，为了避免此种情况导致作业组变成延期或超时，在开启了静默同步后，如果出现同步失败的情况，会在几秒后自动再次同步。

* 当组织单元排班起始时间相同时优化终端自动选择轮班和班次。如果组织单元中存在有多个起始时间相同的轮班，终端会根据轮班制度配置的不同，自动选择当前用户组织单元正确的轮班和班次。

### implus-427：作业项支持文件类型

* 作业项的数据类型支持文件类型，目前终端支持选择照片、视频和图片，同时如果选择关联资产属性，以资产属性值为默认值，该属性值是文件，则获取过来。Web端执行支持选择文件和附件。

  <img alt=" " src={useBaseUrl('docimg/作业项文件类型4301.png')} />

  <img alt=" " src={useBaseUrl('docimg/作业项文件类型4302.png')} />

### implus-475：JSON数据类型中支持文件类型

* 在Json中的数据类型，增加文件类型，适用于所有支持选择和使用Json类型的配置，包括SDC，EOC，Web配置与管理中里。终端支持选择照片、视频和图片，同时如果选择关联资产属性，以资产属性值为默认值，该属性值是文件，则获取过来。Web端执行支持选择文件和附件。

  <img alt=" " src={useBaseUrl('docimg/Json文件类型4301.png')} />

  <img alt=" " src={useBaseUrl('docimg/Json文件类型4302.png')} />

  <img alt=" " src={useBaseUrl('docimg/Json文件类型4303.png')} />

### implus-496：消息通知功能增强

* 增加主动给用户发送消息的接口，可以用用户ID或用户名或登录名。

  <img alt=" " src={useBaseUrl('docimg/发送消息4301.png')} />

* 在作业组属性更多设置中，添加流程后脚本，通过脚本决定发送对象和消息内容，以及发送消息。常规的脚本如下：

```js
// 定义消息主体
var body = {
    'Modes': [
        1,
        3
    ],    
    'Topic': '这是消息标题',
    'Message': '这是消息内容',    
    'RecipientIDList': [
        '1ebba72d-5155-41ba-967d-d5c4082d0f99'
    ],
    'UserNameList': [
        'a11甲班监理员'
    ],
    'LoginIDList': [
        'a1'
    ]
};

// 发送消息并获取结果
var result = imClient.Post('Msg/SendMessage', JSON.stringify(body));

// 解析返回结果为对象
var resultObj = JSON.parse(result);

// 判断返回结果是否存在
if (resultObj) {
    // 判断返回结果是否成功
    if (resultObj.IsOk) {
        // 记录成功调用的日志
        imLogWriter.WriteError('主动发送消息 调用成功，返回数据为：' + JSON.stringify(resultObj.Response));
    }
    else {
        // 记录调用成功但返回错误的日志，并显示错误信息
        imLogWriter.WriteError('主动发送消息 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
    }
}
else {
    // 记录调用失败的日志，并显示返回信息
    imLogWriter.WriteError('主动发送消息 调用失败，返回为：' + result);
}
```

* 用户名如果从作业组属性获取,配置如下：

  <img alt=" " src={useBaseUrl('docimg/发送消息4302.png')} />

* 流程中结束事件使用流程后函数触发该脚本：

  <img alt=" " src={useBaseUrl('docimg/发送消息4303.png')} />

* 脚本如下：

```js
// 获取当前任务组的ID
var taskGroupID = curTaskGroup.ID;

// 定义需要获取作业组属性的名称
var sID = '人员2';

// 声明变量用于存储作业组属性
var sIDProperty;

// 构建获取作业组属性的请求URL
var url = 'Report/GetTaskGroupPropertyByName?taskGroupID=' + taskGroupID + '&name=' + sID;

// 发送获取作业组属性的请求并获取结果
var result = imClient.Get(url);

// 解析返回结果为对象
var resultObj = JSON.parse(result);

// 判断返回结果是否存在
if (resultObj) {
    // 判断返回结果是否成功
    if (resultObj.IsOk) {
        // 获取作业组属性值
        sIDProperty = resultObj.Response;
        
        // 记录成功调用的日志，并显示返回的作业组属性数据
        imLogWriter.WriteError('获取作业组属性 调用成功，返回数据为：' + JSON.stringify(sIDProperty));
    }
    else {
        // 记录调用成功但返回错误的日志，并显示错误信息
        imLogWriter.WriteError('获取作业组属性 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
    }
}
else {
    // 记录调用失败的日志，并显示返回信息
    imLogWriter.WriteError('获取作业组属性 调用失败，返回为：' + result);
}

// 解析作业组属性的值，将其以逗号分隔为一个用户名列表
var userNameList = sIDProperty.Value.split(',');

// 构建发送消息的请求主体
var body = {
    'Modes': [
        1,
        2
    ],    
    'Topic': '这是消息标题',
    'Message': '这是消息内容',        
    'UserNameList': userNameList
};

// 发送消息并获取结果
var result = imClient.Post('Msg/SendMessage', JSON.stringify(body));

// 解析返回结果为对象
var resultObj = JSON.parse(result);

// 判断返回结果是否存在
if (resultObj) {
    // 判断返回结果是否成功
    if (resultObj.IsOk) {
        // 记录成功调用的日志，并显示返回的消息数据
        imLogWriter.WriteError('主动发送消息 调用成功，返回数据为：' + JSON.stringify(resultObj.Response));
    }
    else {
        // 记录调用成功但返回错误的日志，并显示错误信息
        imLogWriter.WriteError('主动发送消息 调用成功，但返回错误，错误信息为：' + resultObj.ErrorMsg);
    }
}
else {
    // 记录调用失败的日志，并显示返回信息
    imLogWriter.WriteError('主动发送消息 调用失败，返回为：' + result);
}
```

* 结果如下：

  <img alt=" " src={useBaseUrl('docimg/发送消息4304.png')} />

* 可以通过脚本给用户增加动态订阅项，如：通过脚本订阅作业组实例所有消息，通过脚本订阅作业组实例和活动实例所有消息，通过脚本订阅作业组实例、活动实例和序列实例所有消息。

### implus-509：终端显示资产属性页面增加显示某个属性的历史和趋势

### implus-511：终端默认数据库类型为sqllite数据库，样式为新样式

### implus-521：升级部署方式和安装盘
